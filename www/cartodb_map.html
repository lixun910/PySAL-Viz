

<!DOCTYPE html>
<html>
<head>
<title>Leaflet example | CartoDB.js</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
<style>
html, body, #map {
  height: 100%;
  padding: 0;
  margin: 0;
}
</style>
<link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
<script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/d3.v3.min.js"></script>
<script src="js/colorbrewer.js"></script>
<script src="js/jmap.js"></script>
<script src="js/utils.js"></script>
<script>

var map;
$(document).ready(function() {

  //////////////////////////////////////////////////////////////
  // Create Theme/Themeless Maps
  //////////////////////////////////////////////////////////////
  var msg = window.opener.tempMsg,
      uuid = msg.uuid,
      title = msg.title,
      sublayers = JSON.parse(msg.sublayers),
      data = window.opener.dataDict[uuid];
  //window.opener.tempMsg = undefined;
  
  map = new L.Map('map', {
    center: [43, -98],
    zoom: 4
  });

  L.tileLayer('http://tile.stamen.com/toner/{z}/{x}/{y}.png', {
        attribution: 'Mapbox <a href="http://mapbox.com/about/maps" target="_blank">Terms &amp; Feedback</a>'
  }).addTo(map);

  cartodb.createLayer(map, {
          user_name: 'lixun910',
          type: 'cartodb',
          /*sublayers: [{
             sql: 'select a.the_geom_webmercator,a.cartodb_id,b.lisa from nat as a, hr60_lisa as b where a.cartodb_id=b.cartodb_id',
             cartocss: '#layer { polygon-fill: #F00; polygon-opacity: 0.3; line-color: #F00; } #layer[lisa="1"]{polygon-fill:blue;}',
             interactivity: 'cartodb_id'
          }]*/
          sublayers: sublayers
        })
    .addTo(map)
    .on('done', function(layer) {
      //cdb.vis.Vis.addInfowindow(map, layer.getSubLayer(0), ['lisa'])
    })
    .on('error', function() {
    }
  );
    
  mymap = new GeoVizMap(new LeafletMap(data, L, map), $('#foreground'), {
    "hratio": 1,
    "vratio": 1,
    "alpha": 0.6,
    });

  map.on('zoomstart', function() {
    mymap.clean();
  });
  map.on('zoomend', function() {
    mymap.update();
  });
  map.on('movestart', function(e) {
    mymap.clean();
  });
  map.on('moveend', function(e) {
    var op = e.target.getPixelOrigin();
    var np = e.target._getTopLeftPoint();
    var offsetX = -np.x + op.x;
    var offsetY = -np.y + op.y;
    mymap.update({"offsetX":offsetX, "offsetY":offsetY});
  });
});
</script>
</head>
<body>
<div id="map-container" style="position: relative; align:center; border: 0px solid red;height: 100%;position: relative;">
  <div id="map" style="align:center; margin-top:0px;border: 0px solid red;width: 800px;height:500px;">
  </div>
  <canvas id="foreground" style="position: absolute; top: 0; left: 0;width: 100%; height: 100%"></canvas>
</div>
</body>
</html>
